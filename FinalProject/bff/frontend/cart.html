<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Shopping Cart | PhoneHub</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/styles.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container px-4 px-lg-5">
      <a class="navbar-brand fw-bold text-primary" href="index.html">
        <i class="bi bi-phone me-2"></i>PhoneHub
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
        data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
          <li class="nav-item"><a class="nav-link" href="index.html">
            <i class="bi bi-house me-1"></i>Home
          </a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
              Categories
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item filter-category" href="index.html" data-category="1">Phone Cases</a></li>
              <li><a class="dropdown-item filter-category" href="index.html" data-category="2">Chargers & Cables</a></li>
              <li><a class="dropdown-item filter-category" href="index.html" data-category="3">Headphones & Audio</a></li>
              <li><a class="dropdown-item filter-category" href="index.html" data-category="4">Car Mounts & Stands</a></li>
              <li><a class="dropdown-item filter-category" href="index.html" data-category="5">Screen Protectors</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item filter-category" href="index.html" data-category="">All Products</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="admin.html">
              <i class="bi bi-gear me-1"></i>Admin
            </a>
          </li>
        </ul>

        <!-- User Navigation - Will be populated by JavaScript -->
        <div class="d-flex gap-2" id="navbar-user-section">
          <!-- Default buttons - will be replaced by JavaScript based on login status -->
          <a href="login.html" class="btn btn-outline-primary">
            <i class="bi bi-box-arrow-in-right me-1"></i>Login
          </a>
          <a href="register.html" class="btn btn-primary">
            <i class="bi bi-person-plus me-1"></i>Register
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="bg-white border-bottom">
    <div class="container px-4 px-lg-5">
      <ol class="breadcrumb py-3 mb-0">
        <li class="breadcrumb-item"><a href="index.html" class="text-decoration-none">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
      </ol>
    </div>
  </nav>

  <!-- Cart Header -->
  <section class="py-4 bg-primary text-white">
    <div class="container px-4 px-lg-5">
      <div class="text-center">
        <h1 class="display-5 fw-bolder">
          <i class="bi bi-cart3 me-3"></i>Your Shopping Cart
        </h1>
        <p class="lead mb-0">Review your items and proceed to checkout</p>
      </div>
    </div>
  </section>

  <!-- Cart Content -->
  <section class="py-5">
    <div class="container px-4 px-lg-5">
      <div class="row">
        <!-- Cart Items Column -->
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                  <i class="bi bi-bag-check me-2 text-primary"></i>Cart Items
                </h4>
                <button class="btn btn-outline-danger btn-sm" onclick="clearCart()" id="clear-cart-btn" style="display: none;">
                  <i class="bi bi-trash me-1"></i>Clear Cart
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <!-- Loading State -->
              <div id="cart-loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading cart...</span>
                </div>
                <p class="mt-2 text-muted">Loading your cart items...</p>
              </div>

              <!-- Empty Cart State -->
              <div id="empty-cart" class="text-center py-5" style="display: none;">
                <i class="bi bi-cart-x display-1 text-muted opacity-50 mb-4"></i>
                <h5 class="text-muted">Your cart is empty</h5>
                <p class="text-muted mb-4">Looks like you haven't added any items to your cart yet.</p>
                <a href="index.html" class="btn btn-primary">
                  <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                </a>
              </div>

              <!-- Cart Items Container -->
              <div id="cart-items-container" style="display: none;">
                <div id="cart-items">
                  <!-- Cart items will be injected here by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <!-- Recommended Products -->
          <div class="card shadow-sm mt-4" id="recommended-section" style="display: none;">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-lightbulb me-2 text-warning"></i>You might also like
              </h5>
            </div>
            <div class="card-body">
              <div class="row" id="recommended-products">
                <!-- Recommended products will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Cart Summary Column -->
        <div class="col-lg-4">
          <div class="card shadow-sm position-sticky" style="top: 20px;">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="bi bi-calculator me-2"></i>Order Summary
              </h5>
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <span id="cart-subtotal">$0.00</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Shipping:</span>
                <span id="cart-shipping">$0.00</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Tax:</span>
                <span id="cart-tax">$0.00</span>
              </div>
              <div class="d-flex justify-content-between mb-2 text-success" id="savings-row" style="display: none;">
                <span><i class="bi bi-tag me-1"></i>You Save:</span>
                <span id="cart-savings">$0.00</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between fw-bold fs-5">
                <span>Total:</span>
                <span id="cart-total" class="text-primary">$0.00</span>
              </div>
            </div>
            <div class="card-footer bg-white">
              <div class="d-grid gap-2">
                <button class="btn btn-primary btn-lg" id="checkout-btn" onclick="proceedToCheckout()" disabled>
                  <i class="bi bi-credit-card me-2"></i>Proceed to Checkout
                </button>
                <a href="index.html" class="btn btn-outline-primary">
                  <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                </a>
              </div>

              <!-- Promo Code Section -->
              <div class="mt-3">
                <div class="input-group">
                  <input type="text" class="form-control" id="promo-code" placeholder="Enter promo code">
                  <button class="btn btn-outline-secondary" type="button" onclick="applyPromoCode()">
                    Apply
                  </button>
                </div>
                <small class="text-muted">Have a discount code? Enter it above.</small>
              </div>
            </div>
          </div>

          <!-- Trust Badges -->
          <div class="card shadow-sm mt-3">
            <div class="card-body text-center">
              <div class="row">
                <div class="col-4">
                  <i class="bi bi-shield-check text-success fs-4"></i>
                  <small class="d-block text-muted">Secure</small>
                </div>
                <div class="col-4">
                  <i class="bi bi-truck text-primary fs-4"></i>
                  <small class="d-block text-muted">Free Ship</small>
                </div>
                <div class="col-4">
                  <i class="bi bi-arrow-clockwise text-info fs-4"></i>
                  <small class="d-block text-muted">Returns</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-5 bg-dark text-white">
    <div class="container px-4 px-lg-5">
      <div class="row gx-4 gx-lg-5">
        <div class="col-lg-4 mb-4">
          <h5 class="fw-bold">
            <i class="bi bi-phone me-2"></i>PhoneHub
          </h5>
          <p class="mb-0">Your trusted partner for premium phone accessories since 2025.</p>
        </div>
        <div class="col-lg-2 col-md-4 mb-4">
          <h6 class="fw-bold">Categories</h6>
          <ul class="list-unstyled">
            <li><a href="index.html" class="text-white-50">Phone Cases</a></li>
            <li><a href="index.html" class="text-white-50">Chargers</a></li>
            <li><a href="index.html" class="text-white-50">Audio</a></li>
            <li><a href="index.html" class="text-white-50">Car Mounts</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-4 mb-4">
          <h6 class="fw-bold">Support</h6>
          <ul class="list-unstyled">
            <li><a href="#" class="text-white-50">Contact Us</a></li>
            <li><a href="#" class="text-white-50">Returns</a></li>
            <li><a href="#" class="text-white-50">Shipping</a></li>
            <li><a href="#" class="text-white-50">FAQ</a></li>
          </ul>
        </div>
        <div class="col-lg-4 col-md-4">
          <h6 class="fw-bold">Connect With Us</h6>
          <div class="d-flex gap-3">
            <a href="#" class="text-white-50 fs-4"><i class="bi bi-facebook"></i></a>
            <a href="#" class="text-white-50 fs-4"><i class="bi bi-twitter"></i></a>
            <a href="#" class="text-white-50 fs-4"><i class="bi bi-instagram"></i></a>
            <a href="#" class="text-white-50 fs-4"><i class="bi bi-youtube"></i></a>
          </div>
        </div>
      </div>
      <hr class="my-4">
      <p class="m-0 text-center text-white-50">&copy; 2025 PhoneHub. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/scripts.js"></script>

  <script>
    // Cart-specific functionality
    let cartItems = [];
    let cartTotal = 0;
    let cartSubtotal = 0;
    let appliedPromoCode = null;

    // Enhanced cart loading function
    async function loadCartItems() {
      try {
        const loadingEl = document.getElementById('cart-loading');
        const emptyCartEl = document.getElementById('empty-cart');
        const cartContainerEl = document.getElementById('cart-items-container');
        const checkoutBtn = document.getElementById('checkout-btn');
        const clearCartBtn = document.getElementById('clear-cart-btn');

        // Show loading state
        loadingEl.style.display = 'block';
        emptyCartEl.style.display = 'none';
        cartContainerEl.style.display = 'none';

        // Check if user is logged in
        if (!currentUser) {
          // Use local cart
          cartItems = JSON.parse(localStorage.getItem('phonehub_cart')) || [];
        } else {
          // Fetch from server
          try {
            const res = await fetch('/api/cart-items', { credentials: 'include' });
            if (res.ok) {
              cartItems = await res.json();
            } else {
              // Fallback to local cart
              cartItems = JSON.parse(localStorage.getItem('phonehub_cart')) || [];
            }
          } catch (err) {
            console.error('Failed to fetch cart from server:', err);
            cartItems = JSON.parse(localStorage.getItem('phonehub_cart')) || [];
          }
        }

        // Hide loading
        loadingEl.style.display = 'none';

        if (cartItems.length === 0) {
          emptyCartEl.style.display = 'block';
          checkoutBtn.disabled = true;
          clearCartBtn.style.display = 'none';
        } else {
          cartContainerEl.style.display = 'block';
          checkoutBtn.disabled = false;
          clearCartBtn.style.display = 'inline-block';
          renderCartItems();
        }

        calculateCartTotals();
        updateCartSummary();

      } catch (error) {
        console.error('Error loading cart:', error);
        document.getElementById('cart-loading').style.display = 'none';
        PhoneHubApp.showNotification('Failed to load cart items', 'error');
      }
    }

    function renderCartItems() {
      const cartItemsEl = document.getElementById('cart-items');
      cartItemsEl.innerHTML = '';

      cartItems.forEach((item, index) => {
        const itemPrice = parseFloat(item.price || item.list_price || 0);
        const itemTotal = (itemPrice * item.quantity).toFixed(2);

        const cartItemEl = document.createElement('div');
        cartItemEl.className = 'border-bottom p-4';
        cartItemEl.innerHTML = `
          <div class="row align-items-center">
            <div class="col-md-2">
              <img src="https://dummyimage.com/150x150/dee2e6/6c757d.jpg"
                   alt="${item.name || item.product_name || 'Product'}"
                   class="img-fluid rounded">
            </div>
            <div class="col-md-4">
              <h6 class="mb-1">${item.name || item.product_name || 'Product'}</h6>
              <small class="text-muted">SKU: ${item.product_id || item.productId}</small>
              ${item.description ? `<p class="text-muted small mb-0">${item.description}</p>` : ''}
            </div>
            <div class="col-md-2 text-center">
              <div class="fw-bold text-primary">$${itemPrice.toFixed(2)}</div>
            </div>
            <div class="col-md-2">
              <div class="input-group input-group-sm">
                <button class="btn btn-outline-secondary" type="button" onclick="updateCartQuantity(${index}, -1)">
                  <i class="bi bi-dash"></i>
                </button>
                <input type="number" class="form-control text-center" value="${item.quantity}" min="1" max="10"
                       onchange="setCartQuantity(${index}, this.value)">
                <button class="btn btn-outline-secondary" type="button" onclick="updateCartQuantity(${index}, 1)">
                  <i class="bi bi-plus"></i>
                </button>
              </div>
            </div>
            <div class="col-md-1 text-center">
              <div class="fw-bold">$${itemTotal}</div>
            </div>
            <div class="col-md-1 text-center">
              <button class="btn btn-outline-danger btn-sm" onclick="removeFromCartByIndex(${index})" title="Remove item">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
        cartItemsEl.appendChild(cartItemEl);
      });
    }

    function calculateCartTotals() {
      cartSubtotal = cartItems.reduce((total, item) => {
        const itemPrice = parseFloat(item.price || item.list_price || 0);
        return total + (itemPrice * item.quantity);
      }, 0);

      // Calculate shipping (free over $50)
      const shipping = cartSubtotal > 50 ? 0 : 5.99;

      // Calculate tax (8.5%)
      const tax = cartSubtotal * 0.085;

      // Apply promo code discount if applicable
      let discount = 0;
      if (appliedPromoCode) {
        discount = cartSubtotal * (appliedPromoCode.discount / 100);
      }

      cartTotal = cartSubtotal + shipping + tax - discount;
    }

    function updateCartSummary() {
      document.getElementById('cart-subtotal').textContent = `$${cartSubtotal.toFixed(2)}`;
      document.getElementById('cart-shipping').textContent = cartSubtotal > 50 ? 'FREE' : '$5.99';
      document.getElementById('cart-tax').textContent = `$${(cartSubtotal * 0.085).toFixed(2)}`;
      document.getElementById('cart-total').textContent = `$${cartTotal.toFixed(2)}`;

      // Show savings if applicable
      const savingsRow = document.getElementById('savings-row');
      const savingsEl = document.getElementById('cart-savings');
      if (appliedPromoCode) {
        const discount = cartSubtotal * (appliedPromoCode.discount / 100);
        savingsEl.textContent = `$${discount.toFixed(2)}`;
        savingsRow.style.display = 'flex';
      } else {
        savingsRow.style.display = 'none';
      }

      // Update cart badge
      if (typeof updateCartBadge === 'function') {
        updateCartBadge();
      }
    }

    function updateCartQuantity(index, change) {
      if (index < 0 || index >= cartItems.length) return;

      const newQuantity = cartItems[index].quantity + change;
      if (newQuantity < 1) {
        removeFromCartByIndex(index);
        return;
      }
      if (newQuantity > 10) return;

      cartItems[index].quantity = newQuantity;
      saveCartToStorage();
      renderCartItems();
      calculateCartTotals();
      updateCartSummary();
    }

    function setCartQuantity(index, quantity) {
      const qty = parseInt(quantity);
      if (qty < 1) {
        removeFromCartByIndex(index);
        return;
      }
      if (qty > 10) return;

      cartItems[index].quantity = qty;
      saveCartToStorage();
      renderCartItems();
      calculateCartTotals();
      updateCartSummary();
    }

    function removeFromCartByIndex(index) {
      if (index < 0 || index >= cartItems.length) return;

      const itemName = cartItems[index].name || cartItems[index].product_name || 'Item';
      cartItems.splice(index, 1);
      saveCartToStorage();

      PhoneHubApp.showNotification(`${itemName} removed from cart`, 'info');

      // Reload cart display
      loadCartItems();
    }

    function clearCart() {
      if (cartItems.length === 0) return;

      if (confirm('Are you sure you want to clear your cart? This action cannot be undone.')) {
        cartItems = [];
        saveCartToStorage();
        PhoneHubApp.showNotification('Cart cleared', 'info');
        loadCartItems();
      }
    }

    function saveCartToStorage() {
      localStorage.setItem('phonehub_cart', JSON.stringify(cartItems));
      // TODO: Also sync with server if user is logged in
    }

    function applyPromoCode() {
      const promoInput = document.getElementById('promo-code');
      const code = promoInput.value.trim().toUpperCase();

      if (!code) {
        PhoneHubApp.showNotification('Please enter a promo code', 'warning');
        return;
      }

      // Mock promo codes for demo
      const validCodes = {
        'SAVE10': { discount: 10, description: '10% off your order' },
        'WELCOME15': { discount: 15, description: '15% off for new customers' },
        'PHONE20': { discount: 20, description: '20% off phone accessories' }
      };

      if (validCodes[code]) {
        appliedPromoCode = validCodes[code];
        appliedPromoCode.code = code;
        calculateCartTotals();
        updateCartSummary();
        PhoneHubApp.showNotification(`Promo code applied! ${validCodes[code].description}`, 'success');
        promoInput.value = '';
        promoInput.placeholder = `Applied: ${code}`;
        promoInput.disabled = true;
      } else {
        PhoneHubApp.showNotification('Invalid promo code', 'error');
      }
    }

    function proceedToCheckout() {
      if (cartItems.length === 0) {
        PhoneHubApp.showNotification('Your cart is empty', 'warning');
        return;
      }

      if (!currentUser) {
        PhoneHubApp.showNotification('Please log in to proceed with checkout', 'warning');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1500);
        return;
      }

      // Store cart data for checkout page
      sessionStorage.setItem('checkout_cart', JSON.stringify({
        items: cartItems,
        subtotal: cartSubtotal,
        total: cartTotal,
        promoCode: appliedPromoCode
      }));

      window.location.href = 'checkout.html';
    }

    // Initialize cart when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for the main initialization to complete
      setTimeout(() => {
        loadCartItems();
      }, 500);
    });

    // Make functions globally available
    window.updateCartQuantity = updateCartQuantity;
    window.setCartQuantity = setCartQuantity;
    window.removeFromCartByIndex = removeFromCartByIndex;
    window.clearCart = clearCart;
    window.applyPromoCode = applyPromoCode;
    window.proceedToCheckout = proceedToCheckout;
  </script>
</body>
</html>
